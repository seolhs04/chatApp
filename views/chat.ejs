<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

    <link rel="stylesheet" href="public/styles/index.css">

    <title>Chat App</title>
  </head>
  <body>
    <%- include('nav.html') %>
    <div>
      <div class="card container" style="height: 33rem; overflow-y: scroll;" id="chatList"></div>
      <div class="input-group container" style="padding: 0">
        <div class="btn-group dropup">
          <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="userList">
            
          </button>
          <ul class="dropdown-menu" id="dropdown-menu">
          </ul>
        </div>
        <input type="text" class="form-control" placeholder="메세지를 입력하세요" aria-label="Recipient's username" aria-describedby="button-addon2" id="textInput">
        <button class="btn btn-dark" type="button" id="button-addon2">전송</button>
      </div>
    </div>



    <!-- socket.io -->
    <script src="https://cdn.socket.io/4.1.1/socket.io.min.js" integrity="sha384-cdrFIqe3RasCMNE0jeFG9xJHog/tgOVC1E9Lzve8LQN1g5WUHo0Kvk1mawWjxX7a" crossorigin="anonymous"></script>

    <script>
      var date = new Date

      // Chatting Connected
      var socket = io();
      const chatList = document.getElementById('chatList');

      
      socket.on('alert', function(data){
          socket.emit('user', {name: localStorage.name, socketId: socket.id});
          var alertText = document.createElement('div');
          alertText.setAttribute('class', 'card')
          alertText.setAttribute('style', 'background-color:#adb5bd; text-align:center; font-weight: bold')
          alertText.innerText = data;
          chatList.append(alertText);
      })

      // receive User Array
      socket.on('user', function(user){
        // li초기화
        var cell = document.getElementById("dropdown-menu");
        while(cell.hasChildNodes()){
          cell.removeChild( cell.firstChild );
        }
        document.getElementById('userList').innerText = `접속 ${user.length}`;
          for(var i=0;i<user.length;i++){
          var user_li = document.createElement('li');
          document.getElementById('dropdown-menu').append(user_li)
          var user_a = document.createElement('a');
          user_a.setAttribute('class', 'dropdown-item');
          user_a.innerText = user[i].name;
          user_li.append(user_a)
        }  
      })

      // submit text
      document.getElementById('button-addon2').onclick = function(){
        if(document.getElementById('textInput').value != ""){
          socket.emit('text', {socketId: socket.id, name: localStorage.name, article: document.getElementById('textInput').value})
          document.getElementById('textInput').value = '';
          document.getElementById('textInput').focus();
        }
      }
      

      // receive & view text
      socket.on('text', function(data){

        // Compare SocketId
        if(socket.id == data.socketId){
          // name
          var nameSpace = document.createElement('p');
          nameSpace.setAttribute('style', 'margin-bottom: 0; margin-right:0; text-align: right; font-weight: bold;');
          nameSpace.innerText = data.name;
          chatList.append(nameSpace)
          // text time box
          var textBox = document.createElement('div');
          textBox.setAttribute('style', 'display: flex;');
          chatList.append(textBox);
          // time
          var timeText = document.createElement('span');
          timeText.setAttribute('style', 'font-size: 0.5rem; margin-left: auto; margin-bottom: 0px; margin-top: auto;');
          timeText.innerText = `${date.getHours() < 10 ? `0${date.getHours()}`: date.getHours()}:${date.getMinutes() < 10 ? `0${date.getMinutes()}`: date.getMinutes()}`;
          textBox.append(timeText);
          // text
          var chatText = document.createElement('div');
          chatText.setAttribute('class', 'card container mt-1');
          chatText.setAttribute('style', 'max-width: 13rem; margin-right: 0; text-align: right; color: white; background-color: #212529; margin-left: 0;');
          chatText.innerText = data.article;
          textBox.append(chatText);
        } else{
          // name
          var nameSpace = document.createElement('p');
          nameSpace.setAttribute('style', 'margin-bottom: 0; font-weight: bold;');
          nameSpace.innerText = data.name;
          chatList.append(nameSpace)
          // text time box
          var textBox = document.createElement('div');
          textBox.setAttribute('style', 'display: flex;');
          chatList.append(textBox);
          // text
          var chatText = document.createElement('div');
          chatText.setAttribute('class', 'card container mt-1');
          chatText.setAttribute('style', 'max-width: 250px; margin-left: 0; margin-right: 0; background-color: #f5f6fa;');
          chatText.innerText = data.article;
          textBox.append(chatText);
          // time
          var timeText = document.createElement('span');
          timeText.setAttribute('style', 'font-size: 0.5rem; margin-right: auto; margin-top: auto;');
          timeText.innerText = `${date.getHours() < 10 ? `0${date.getHours()}`: date.getHours()}:${date.getMinutes() < 10 ? `0${date.getMinutes()}`: date.getMinutes()}`;
          textBox.append(timeText);
        }
        
        
        // chatList Scroll controll
        function moveScroll(){
          var messages = chatList.childNodes
          var offsetMessage = chatList.childNodes[messages.length - 1].offsetTop
          chatList.scrollTo({top:offsetMessage, left:0, behavior:'smooth'});
        }
        moveScroll();
      })

      //Enterkey controll
      document.getElementById('textInput').onkeypress = function(){
        if(event.keyCode == 13){
          if(document.getElementById('textInput').value != ''){
            document.getElementById('button-addon2').click();
          }
        }
      }
    </script>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  </body>
</html>